# Copyright 2020 Google LLC All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: "agones.dev/v1"
kind: Fleet
metadata:
  name: comfyui-agones-fleet-gpu
spec:
  replicas: 1
  template:
    spec:
      container: simple-game-server
      ports:
      - name: default
        container: simple-game-server
        containerPort: 7654
      - name: comfyui
        container: comfyui
        containerPort: 8188
        protocol: TCP
      template:
        metadata:
          annotations:
            cluster-autoscaler.kubernetes.io/safe-to-evict: "true"
        spec:
          serviceAccountName: comfyui-sa
          nodeSelector:
            cloud.google.com/gke-accelerator: nvidia-l4
            cloud.google.com/gke-accelerator-count: "1"
            cloud.google.com/gke-spot: "true"
            cloud.google.com/gke-gpu-sharing-strategy: "time-sharing"
            cloud.google.com/gke-max-shared-clients-per-gpu: "4"            
          containers:
          - name: simple-game-server
            image: <REGION>-docker.pkg.dev/<PROJECT_ID>/<BUILD_REGIST>/game-server:tf
            env:
            - name: APP_PORT
              value: "8188"
            resources:
              requests:
                memory: "64Mi"
                cpu: "20m"
              limits:
                memory: "64Mi"
                cpu: "20m"
          - name: comfyui
            image: <REGION>-docker.pkg.dev/<PROJECT_ID>/<BUILD_REGIST>/comfyui-gke:tf
            command: ["/bin/bash", "start.sh", "--gpu"]
            readinessProbe:
              httpGet:
                path: /
                port: 8188
              initialDelaySeconds: 30
              periodSeconds: 10
            resources:
              requests:
                cpu: 4
                memory: 16Gi
            volumeMounts:
            - name: comfyui-storage
              mountPath: /comfyui_nfs_dir
            resources:
              limits:
                nvidia.com/gpu: "1"
          volumes:
            - name: comfyui-storage
              persistentVolumeClaim:
                claimName: vol1